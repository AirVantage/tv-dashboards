<!DOCTYPE html>
<meta charset="utf-8">

<link type="text/css" rel="stylesheet" href="css/messages.css" media="all">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
<meta http-equiv="Refresh" content="60">

<style>
.counts {
    -moz-column-count:2; /* Firefox */
    -webkit-column-count:2; /* Safari and Chrome */
    /* column-count:2; */
    
    -moz-column-gap:10px; /* Firefox */
    -webkit-column-gap:10px; /* Safari and Chrome */
    /* column-gap:10px; */
}

.label {
    padding: 5px 0px 0px 5px;
    color: white;
    font-family: Verdana, sans-serif;
    font-weight: bold;
    font-size: 68px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    -o-text-overflow: ellipsis;
}

.total {
    text-align: center;
    color: rgb(100, 116, 127);
    font-family: Verdana, sans-serif;
    font-weight: bold;
    font-size: 68px;
}
</style>

<title id='pageTitle'>Open bugs count</title>

<h1 id="title">open bugs</h1>
<div class="counts" id="counts"></div>

<script type="text/javascript">
    function get_query() {
        var url = location.href;
        var qs = url.substring(url.indexOf('?') + 1).split('&');
        for(var i = 0, result = {}; i < qs.length; i++){
            qs[i] = qs[i].split('=');
            result[qs[i][0]] = decodeURIComponent(qs[i][1]);
        }
        return result;
    }

    var jira_url = 'https://issues.sierrawireless.com/rest/api/2/search?jql=';
    var suffix_jira = '&maxResults=1000&tempMax=1000&fields=labels,priority';
    
    // This JQL request must be modified according to current phase of the roadmap execution, given a label for a specific version, for example
    var jql = 'project = PLTBUGS AND type = Bug AND status in (open, Reopened, Incomplete)';
	
	$(document).ready(
            function() {
                $.getJSON(jira_url + encodeURI(jql) + suffix_jira)
                .done(function( json ) {
                        console.log( "JSON Data: " + json.users[ 3 ].name );
                    })
                .fail(function( jqxhr, textStatus, error ) {
                        var err = textStatus + ", " + error;
                        console.log( "Request Failed: " + err );
                        //, function(result) {
                        //console.log(result);
                        //displayResults(result);
                    });
            });
	
    function displayResults(result) {
        console.log(result);
        var counters = new Object();
        $.each(result.issues, function(index, issue) {
            console.log(issue);
            var priority = issue.fields.priority.name;
            var labels = issue.fields.labels;
            for (var index in labels) {
            	var label = labels[index];
            	if (label in counters === false) {
            		counters[label] = new Object();
            	}
            	if (priority in counters[label] === false) {
            		counters[label][priority] = 1;
            	}
            	else {
            		counters[label][priority]++;
            	}
            }
        });
        
        var params = get_query();
        var blacklist = [];
        if (params['blacklist'] !== undefined) {
            blacklist = params['blacklist'].split(',');
        }
        
        var topContainer = $('#counts');
        var labels = Object.keys(counters).sort();
        for (var index in labels) {
        	var label = labels[index];
        	if ($.inArray(label,blacklist) == -1) {
                var total = 0;
                var blocker = 0;
                var critical = 0;
                for (var priority in counters[label]) {
                    total += counters[label][priority];
                    if (priority === 'Blocker') {
                        blocker += counters[label][priority];
                    }
                    if (priority === 'Critical') {
                        blocker += counters[label][priority];
                    }
                }
                labelContainer = topContainer.append($('<div class="label" id="' + label + '">' + label + '&nbsp;<span class="total">' + total + ' (<span style="color: #ff0000;">' + blocker + '</span>/<span style="color: #F87217;">' + critical + '</span>)</span></div>'));
        	}
        }
        $('#title').contents().replaceWith(result.issues.length + ' open bugs');
        $('#pageTitle').contents().replaceWith(result.issues.length + ' open bugs');
    }
</script>
